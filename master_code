import time
import board
import busio
import digitalio
import adafruit_mcp3xxx.mcp3008 as MCP
from adafruit_mcp3xxx.analog_in import AnalogIn
import adafruit_dht
from rich.live import Live
from rich.table import Table
from rich.console import Console
from datetime import datetime

# --- CONFIGURATION ---
# Relay GPIO Pins (Add more as you get more wires/relays)
RELAY_PINS = [2, 3, 4, 17, 27, 22] 
# DHT22 Pins
INDOOR_DHT_PIN = board.D18
OUTDOOR_DHT_PIN = board.D23

# --- HARDWARE SETUP ---
console = Console()
spi = busio.SPI(clock=board.SCK, MISO=board.MISO, MOSI=board.MOSI)

# Setup two MCP3008 chips
cs1 = digitalio.DigitalInOut(board.D24) # CE0
cs2 = digitalio.DigitalInOut(board.D26) # CE1
mcp1 = MCP.MCP3008(spi, cs1)
mcp2 = MCP.MCP3008(spi, cs2)

# Initialize Relays
relays = []
for pin in RELAY_PINS:
    r = digitalio.DigitalInOut(getattr(board, f"D{pin}"))
    r.direction = digitalio.Direction.OUTPUT
    r.value = True # Start OFF (High is OFF for most relay boards)
    relays.append(r)

# Initialize DHT Sensors
dht_in = adafruit_dht.DHT22(INDOOR_DHT_PIN)
dht_out = adafruit_dht.DHT22(OUTDOOR_DHT_PIN)

# Data Tracking
last_watered = ["Never"] * 16
sensor_voltages = [0.0] * 16

def get_all_voltages():
    """Reads all 16 channels across both MCP3008 chips"""
    for i in range(8):
        # Chip 1 (Sensors 1-8)
        sensor_voltages[i] = AnalogIn(mcp1, getattr(MCP, f"P{i}")).voltage
        # Chip 2 (Sensors 9-16)
        sensor_voltages[i+8] = AnalogIn(mcp2, getattr(MCP, f"P{i}")).voltage

def generate_table():
    """Creates the Rich Dashboard Table"""
    table = Table(title="ðŸŒ± Greenhouse Master Dashboard - v2.0", header_style="bold green")
    
    table.add_column("Sensor ID", justify="center", style="cyan")
    table.add_column("Voltage (Raw)", justify="center", style="yellow")
    table.add_column("Status", justify="center")
    table.add_column("Last Watered", justify="center", style="magenta")

    for i in range(16):
        v = sensor_voltages[i]
        
        # Determine status color
        if v < 0.5: status = "[red]DISCONNECTED[/red]"
        elif v > 2.5: status = "[blue]WET[/blue]"
        else: status = "[green]OK[/green]"
        
        # If it's one of your 11 wired sensors, show data, else show "Empty"
        label = f"Sensor {i+1}"
        if i >= 11:
            label = f"[grey42]Sensor {i+1}[/grey42]"
            v_str = "[grey42]--[/grey42]"
            water_str = "[grey42]N/A[/grey42]"
            status = "[grey42]NO WIRE[/grey42]"
        else:
            v_str = f"{v:.2f}V"
            water_str = last_watered[i]

        table.add_row(label, v_str, status, water_str)

    return table

# --- MAIN LOOP ---
console.clear()
with Live(generate_table(), refresh_per_second=1) as live:
    while True:
        try:
            # 1. Update Voltages
            get_all_voltages()
            
            # 2. Update Climate (Try/Except because DHT22s are finicky)
            try:
                temp_in = dht_in.temperature
                hum_in = dht_in.humidity
                climate_str = f"Indoor: {temp_in}Â°C | {hum_in}% RH"
            except:
                climate_str = "Indoor: Sensor Error"

            # 3. Simple Logic Example (If Sensor 1 < 1.5V, Click Relay 1)
            # if sensor_voltages[0] < 1.5:
            #     relays[0].value = False # ON
            #     last_watered[0] = datetime.now().strftime("%H:%M:%S")

            # Update the display
            live.update(generate_table())
            time.sleep(1)

        except Exception as e:
            # This prevents the whole script from crashing if a wire loose
            pass

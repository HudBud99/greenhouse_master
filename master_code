import time
import board
import busio
import adafruit_dht
from digitalio import DigitalInOut, Direction
from adafruit_mcp3xxx.mcp3008 import MCP3008
from adafruit_mcp3xxx.analog_in import AnalogIn

# --- SETUP ---
spi = busio.SPI(clock=board.SCK, MISO=board.MISO, MOSI=board.MOSI)
mcp0 = MCP3008(spi, DigitalInOut(board.CE0)) 
mcp1 = MCP3008(spi, DigitalInOut(board.CE1)) 

# Solenoids 0, 1, 2
TEST_PINS = [board.D2, board.D3, board.D4]
solenoids = [DigitalInOut(p) for p in TEST_PINS]
for s in solenoids:
    s.direction = Direction.OUTPUT
    s.value = True # Start OFF

# DHT22 Climate Sensors
dht_in = adafruit_dht.DHT22(board.D18)
dht_out = adafruit_dht.DHT22(board.D23)

print("--- STARTING FULL DIAGNOSTIC ---")

# 1. Relay "Click" Test
for i, s in enumerate(solenoids):
    print(f"Testing Solenoid {i}... (Check for LED and Click)")
    s.value = False # ON
    time.sleep(2)
    s.value = True  # OFF
    time.sleep(1)

# 2. Climate Sensor Test (3 Attempts)
print("\n--- CLIMATE CHECK ---")
for sensor, name in [(dht_in, "Indoor"), (dht_out, "Outdoor")]:
    success = False
    for attempt in range(3):
        try:
            temp = sensor.temperature
            hum = sensor.humidity
            if temp is not None:
                print(f"{name} Sensor: {temp}Â°C | {hum}% Humidity")
                success = True
                break
        except RuntimeWarning:
            pass # Common DHT error, just retry
        time.sleep(2)
    if not success:
        print(f"{name} Sensor: FAILED to read (Check wiring to GPIO 18/23)")

# 3. Moisture Sensor Voltages
print("\n--- MOISTURE CHECK ---")
for i in range(8):
    v0 = round(AnalogIn(mcp0, i).voltage, 2)
    v1 = round(AnalogIn(mcp1, i).voltage, 2)
    print(f"Ch {i}: {v0}V  |  Ch {i+8}: {v1}V")

print("\nDIAGNOSTIC COMPLETE.")
